Este es un webservice que sirve para consultar a otro servicio externo si una persona se encuentra en losta negra o no.
Mi servicio consume al proveedor externo.. y los sistemas internos utilizan mi servicio para llegar a la información que necesitan.

Actualmente, mi servicio puede responder con la info en dos estructuras diferentes, como un DataSet o un ObjetoComplejo. 

Este es mi Request:

<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:wsl="http://wslistasnegras.banpais.hn/">
   <soapenv:Header/>
   <soapenv:Body>
      <wsl:sendTransactionDS>
         <!--Optional:-->
         <wsl:tramaIdentidad>?</wsl:tramaIdentidad>
         <!--Optional:-->
         <wsl:tramaPrimerNombre>?</wsl:tramaPrimerNombre>
         <!--Optional:-->
         <wsl:tramaSegundoNombre>?</wsl:tramaSegundoNombre>
         <!--Optional:-->
         <wsl:tramaPrimerApellido>?</wsl:tramaPrimerApellido>
         <!--Optional:-->
         <wsl:tramaSegundoApellido>?</wsl:tramaSegundoApellido>
         <!--Optional:-->
         <wsl:tramaTipoPersona>?</wsl:tramaTipoPersona>
         <!--Optional:-->
         <wsl:tramaNacionalidad>?</wsl:tramaNacionalidad>
         <!--Optional:-->
         <wsl:tramaRazonSocial>?</wsl:tramaRazonSocial>
         <!--Optional:-->
         <wsl:tramaFechaNacimiento>?</wsl:tramaFechaNacimiento>
         <!--Optional:-->
         <wsl:tramaGrupoLista>?</wsl:tramaGrupoLista>
      </wsl:sendTransactionDS>
   </soapenv:Body>
</soapenv:Envelope>



y este es el response:

xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
  <soap:Body>
     <sendTransactionDSResponse xmlns="http://wslistasnegras.banpais.hn/">
        <sendTransactionDSResult>
           <xs:schema id="dsRespuesta" xmlns="" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:msdata="urn:schemas-microsoft-com:xml-msdata">
              <xs:element name="dsRespuesta" msdata:IsDataSet="true" msdata:UseCurrentLocale="true">
                 <xs:complexType>
                    <xs:choice minOccurs="0" maxOccurs="unbounded">
                       <xs:element name="dtErrores">
                         <xs:complexType>
                            <xs:sequence>
                                <xs:element name="Codigo" type="xs:string" minOccurs="0"/>
                                <xs:element name="Descripcion" type="xs:string" minOccurs="0"/>
                            </xs:sequence>
                         </xs:complexType>
                       </xs:element>
                       <xs:element name="dtListaNegra">
                         <xs:complexType>
                            <xs:sequence>
                                <xs:element name="Identidad" type="xs:string" minOccurs="0"/>
                                <xs:element name="Nombre" type="xs:string" minOccurs="0"/>
                                <xs:element name="Respuesta" type="xs:string" minOccurs="0"/>
                                <xs:element name="NombreCoincidencia" type="xs:string" minOccurs="0"/>
                                <xs:element name="Porcentaje" type="xs:string" minOccurs="0"/>
                                <xs:element name="Lista" type="xs:string" minOccurs="0"/>
                            </xs:sequence>
                         </xs:complexType>
                       </xs:element>
                    </xs:choice>
                 </xs:complexType>
              </xs:element>
           </xs:schema>
           <diffgr:diffgram xmlns:msdata="urn:schemas-microsoft-com:xml-msdata" xmlns:diffgr="urn:schemas-microsoft-com:xml-diffgram-v1">
              <dsRespuesta xmlns="">
                 <dtListaNegra diffgr:id="dtListaNegra1" msdata:rowOrder="0" diffgr:hasChanges="inserted">
                    <Identidad>1</Identidad>
                   <Respuesta>F</Respuesta>
                 </dtListaNegra>
              </dsRespuesta>
           </diffgr:diffgram>
        </sendTransactionDSResult>
     </sendTransactionDSResponse>
  </soap:Body>


Actualmente, mi servicio funciona bien para persona natural, sin embargo, para persona juridica no.

Ahorita el error es que, al llenar el tipo de persona, el primer nombre, la razon social, la fecha, la nacionalidad, el grupo lista... logra buscar la empresa con el proveedor.. es decir, si funciona para buscar a una entidad juridica, pero no deberia ser asi ... asi que, quien tiene el verdadero error es el proveedor, porque, el lugar de que solo vaya lleno la raon social, toma el primer nombre(que de nuestro lado el usuario coloca el nombre de la empresa alli) y se los busca. 
Nosotros no podemos hacer que el proveedor arregle eso, pero si podemos hacer switch visualmente y que las tramas se sigan enviando como ahorita...


Entonces, cómo solucionamos esto?

1. Se debe validar cómo viene lleno el campo de tramaTipoPersona (N o J).
2. Si el campo tramaTipoPersona viene con N (Persona Natural), entonces ... Debe venir obligatoriamente los siguientes campos: tramaIdentidad, tramaPrimerNombre, tramaSegundoNombre, tramaPrimerApellido, tramaSegundoApellido, obviamente la tramaTipoPersona deberia estar lleno, tramaNacionalidad,tramaFechaNacimiento, tramaGrupoLista
3. Si el campo tramaTipoPersona viene con J (Persona Jurídica), entonces... Debe venir oblogatorioamente los siguientes campos: tramaIdentidad, obviamente el campo tramaTipoPersona, tramaNacionalidad, tramaRazonSocial(que para que no haya problemas esta debe eviarse tambien en le trama de PrimerNombre, porque el proveedor tiene eso mal), tramaFechaNacimiento, tramaGrupoLista
4. Agregar todas las validaciones necesarias para que funcione como se debe
5. Agregar un flag en el config, para cuando el proveedor decida arreglar bien lo de las consultas juridicas, y ya no sea necesario pasar la razonSocial a primerNombre


Este es el codigo donde necesito hacer la modificacion:

using DataLayer;
using log4net;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Globalization;
using System.Linq;
using System.Net;
using System.Web;
using System.Web.Services;
using wsListasNegras.Clases;
using wsListasNegras.wsRecibeInt;

namespace wsListasNegras
{
    /// <summary>
    /// Summary description for ListasNegras
    /// </summary>
    [WebService(Description = "WebService que funciona como puente para consultas a Listas Negras de MonitorPlus", Namespace = "http://wslistasnegras.banpais.hn/")]
    [WebServiceBinding(ConformsTo = WsiProfiles.BasicProfile1_1)]
    [System.ComponentModel.ToolboxItem(false)]
    // To allow this Web Service to be called from script, using ASP.NET AJAX, uncomment the following line. 
    // [System.Web.Script.Services.ScriptService]
    public class ListasNegras : System.Web.Services.WebService
    {
        private static readonly ILog Logger = LogManager.GetLogger(typeof(xmlwsAD));
        RecibeIntSoapClient wsListasNegras = new RecibeIntSoapClient();

        [WebMethod]
        public DataSet sendTransactionDS(string tramaIdentidad, string tramaPrimerNombre, string tramaSegundoNombre, string tramaPrimerApellido, string tramaSegundoApellido, string tramaTipoPersona, string tramaNacionalidad, string tramaRazonSocial, string tramaFechaNacimiento, string tramaGrupoLista)
        {
            DataSet dsEnvioTransaccion = EnvioTransaccion(tramaIdentidad, tramaPrimerNombre, tramaSegundoNombre, tramaPrimerApellido, tramaSegundoApellido, tramaTipoPersona, tramaNacionalidad, tramaRazonSocial, tramaFechaNacimiento, tramaGrupoLista);

            Logger.Info($"sendTransactionDS - Se retorno:\n{dsEnvioTransaccion.GetXml()}");

            return dsEnvioTransaccion;
        }

        [WebMethod]
        public clientBlackList sendTransactionOC(string tramaIdentidad, string tramaPrimerNombre, string tramaSegundoNombre, string tramaPrimerApellido, string tramaSegundoApellido, string tramaTipoPersona, string tramaNacionalidad, string tramaRazonSocial, string tramaFechaNacimiento, string tramaGrupoLista)
        {
            
            DataSet dsEnvioTransaccion = new DataSet();

            try
            {
                dsEnvioTransaccion = EnvioTransaccion(tramaIdentidad, tramaPrimerNombre, tramaSegundoNombre, tramaPrimerApellido, tramaSegundoApellido, tramaTipoPersona, tramaNacionalidad, tramaRazonSocial, tramaFechaNacimiento, tramaGrupoLista);
            }
            catch(Exception ex)
            {
                Logger.Error($"Error sendTransactionOC.\n{ex.Message}\n{ex.Source}\n{ex.StackTrace}");
            }

            //Pasamos de DataSet a Objeto Complejo para el return
            clientBlackList rBlackList = new clientBlackList();

            if (dsEnvioTransaccion.Tables["dtErrores"].Rows.Count > 0)
            {
                rBlackList.errores.codigo = dsEnvioTransaccion.Tables["dtErrores"].Rows[0]["Codigo"].ToString();
                rBlackList.errores.descripcion = dsEnvioTransaccion.Tables["dtErrores"].Rows[0]["Descripcion"].ToString();
            }
            if (dsEnvioTransaccion.Tables["dtListaNegra"].Rows.Count > 0)
            {
                rBlackList.Respuesta = dsEnvioTransaccion.Tables["dtListaNegra"].Rows[0]["Respuesta"].ToString();
            }

            Logger.Info($"sendTransactionOC - Se retorno:\n{rBlackList.toString()}");

            return rBlackList;
        }

        private DataSet EnvioTransaccion(string tramaIdentidad, string tramaPrimerNombre, string tramaSegundoNombre, string tramaPrimerApellido, string tramaSegundoApellido, string tramaTipoPersona, string tramaNacionalidad, string tramaRazonSocial, string tramaFechaNacimiento, string tramaGrupoLista)
        {
            DataSet dsRespuesta = new DataSet("dsRespuesta");

            DataTable dtErrores = new DataTable("dtErrores");
            dtErrores.Columns.Add(new DataColumn("Codigo", typeof(string)));
            dtErrores.Columns.Add(new DataColumn("Descripcion", typeof(string)));

            DataTable dtListaNegra = new DataTable("dtListaNegra");
            dtListaNegra.Columns.Add(new DataColumn("Identidad", typeof(string)));
            dtListaNegra.Columns.Add(new DataColumn("Nombre", typeof(string)));
            dtListaNegra.Columns.Add(new DataColumn("Respuesta", typeof(string)));
            dtListaNegra.Columns.Add(new DataColumn("NombreCoincidencia", typeof(string)));
            dtListaNegra.Columns.Add(new DataColumn("Porcentaje", typeof(string)));
            dtListaNegra.Columns.Add(new DataColumn("Lista", typeof(string)));

            string RealTime = string.Empty;
            string Evento = string.Empty;
            string Usuario = string.Empty;

            SQLSrv qConfiguracionesBD = new SQLSrv(Properties.Settings.Default.cnx_wsListasNegras, "usp_GetConfiguraciones");
            qConfiguracionesBD.Parametros.Add(new SqlParameter("@IdBuscar", 3));

            Logger.Error($"Ejecutando usp_GetConfiguraciones @IdBuscar: 3");

            DataTable dtLogConfDT = qConfiguracionesBD.getDataTableWithParameters();

            if (!qConfiguracionesBD.Success)
                Logger.Error($"No se pudo guardar LogSQL:\n{qConfiguracionesBD.Mensaje}");
            else
            {
                if (dtLogConfDT.Rows.Count > 0)
                    RealTime = dtLogConfDT.Rows[0][0].ToString();
            }

            qConfiguracionesBD.Parametros.Add(new SqlParameter("@IdBuscar", 4));

            Logger.Error($"Ejecutando usp_GetConfiguraciones @IdBuscar: 4");

            dtLogConfDT = qConfiguracionesBD.getDataTableWithParameters();
            if (!qConfiguracionesBD.Success)
                Logger.Error($"No se pudo guardar LogSQL:\n{qConfiguracionesBD.Mensaje}");
            else
            {
                if (dtLogConfDT.Rows.Count > 0)
                    Evento = dtLogConfDT.Rows[0][0].ToString();
            }

            string usuario = string.Empty;
            string pass = string.Empty;
            bool superoValidaciones = true;

            if (Properties.Settings.Default.ValidaUSREnvioTrama)
            {
                try
                {
                    HttpContext context = HttpContext.Current;
                    usuario = context.Request.Headers["username"].ToString();
                    Usuario = usuario;
                    pass = context.Request.Headers["pass"].ToString();
                }
                catch (Exception ex)
                {
                    superoValidaciones = false;

                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E016";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = $"No se encontraron credenciales en el Header.\n{ex.Message}\n{ex.StackTrace}";
                }
            }

            //Validando usuario y contraseña del Header
            if (!CredencialesValidas(usuario, pass))
            {
                dtErrores.Rows.Add(1);
                dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E000";
                dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Credenciales de no validas!";
            }
            else
            {
                //Validaciones
                if (RealTime.ToUpper() != "S" && RealTime.ToUpper() != "N")
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E006";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro RealTime solo puede ser S o N.";
                    superoValidaciones = false;
                }

                if (Evento.ToString().Length > 5)
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E007";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro Evento solo puede ser de 5 digitos.";
                    superoValidaciones = false;
                }

                if (tramaIdentidad.Length > 18)
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E008";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro tramaIdentidad no puede ser mas de 18 caracteres.";
                    superoValidaciones = false;
                }

                if (tramaTipoPersona.ToUpper() != "N" && tramaTipoPersona.ToUpper() != "J")
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E009";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro tramaTipoPersona solo puede ser N o J.";
                    superoValidaciones = false;
                }

                if (tramaNacionalidad.Length > 20)
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E010";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro tramaNacionalidad solo puede ser de 20 caracteres.";
                    superoValidaciones = false;
                }

                if (tramaRazonSocial.Length > 200)
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E011";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro tramaRazonSocial solo puede ser de 200 caracteres.";
                    superoValidaciones = false;
                }

                if (tramaFechaNacimiento.Length != 8)
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E012";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro tramaFechaNacimiento solo puede ser de 8 caracteres.";
                    superoValidaciones = false;
                }

                if (!ValidaFecha(tramaFechaNacimiento))
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E013";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro tramaFechaNacimiento no tiene un formato valido.";
                    superoValidaciones = false;
                }

                if (tramaGrupoLista.Length > 2)
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E014";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro tramaGrupoLista solo puede ser de 2 caracteres.";
                    superoValidaciones = false;
                }

                if (!ValidaGrupo(tramaGrupoLista))
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E015";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro tramaGrupo no tiene un valor valido.";
                    superoValidaciones = false;
                }

                if (superoValidaciones)
                {
                    DateTime FechaActual = System.DateTime.Now;
                    string tramaFechaEvaluacion = FechaActual.ToString("yyyyMMdd");

                    //Arma trama a Enviar en metodo SendTransaction
                    string tramaEnviar =
                        RealTime.ToUpper()
                        + FechaActual.Day.ToString().PadLeft(2, '0')
                        + FechaActual.Month.ToString().PadLeft(2, '0')
                        + FechaActual.Year.ToString().PadLeft(4, '0')
                        + FechaActual.Hour.ToString().PadLeft(2, '0')
                        + FechaActual.Minute.ToString().PadLeft(2, '0')
                        + Evento.ToString().PadLeft(5, '0')
                        + Usuario.PadRight(10, ' ').ToUpper()
                        + tramaIdentidad.PadRight(18, ' ')
                        + tramaPrimerNombre.PadRight(50, ' ')
                        + tramaSegundoNombre.PadRight(50, ' ')
                        + tramaPrimerApellido.PadRight(50, ' ')
                        + tramaSegundoApellido.PadRight(50, ' ')
                        + tramaTipoPersona.ToUpper()
                        + tramaFechaEvaluacion
                        + tramaNacionalidad.PadRight(20, ' ')
                        + tramaRazonSocial.PadRight(200, ' ').ToUpper()
                        + tramaFechaNacimiento
                        + tramaGrupoLista.PadLeft(2, '0')
                        + "".PadRight(47, ' ');

                    tramaEnviar = tramaEnviar.ToUpper();

                    Logger.Info($"EnvioTransaccion - Trama enviada a RecibeInt: '{tramaEnviar}'");

                    //Consumir web service
                    string respListaNegras = string.Empty;

                    try
                    {
                        //Se revisa si ya se consulto anteriormente este trama y si esta en la bd

                        SQLSrv qLogBD = new SQLSrv(Properties.Settings.Default.cnx_wsListasNegras, "usp_RevisarLogEnvioRepuesta");
                        qLogBD.Parametros.Add(new SqlParameter("@TramaEnviada", tramaEnviar));

                        Logger.Error($"Ejecutando usp_RevisarLogEnvioRepuesta @TramaEnviada: {tramaEnviar}");

                        DataTable dtogDT = qLogBD.getDataTableWithParameters();

                        if(!qLogBD.Success)
                        {
                            Logger.Error($"Error Ejecutando usp_RevisarLogEnvioRepuesta @TramaEnviada: {tramaEnviar}");
                        }
                        else
                        {
                            if(dtogDT.Rows.Count>0)
                                respListaNegras = dtogDT.Rows[0][0].ToString();
                        }                     


                        if (dtogDT.Rows.Count <= 0)
                        {
                            if (Properties.Settings.Default.UsarRespuestaAutomatica == false)
                            {
                                try
                                {
                                    ServicePointManager.SecurityProtocol =
                                    SecurityProtocolType.Tls |           // TLS 1.0
                                    SecurityProtocolType.Tls11 |         // TLS 1.1
                                    SecurityProtocolType.Tls12;         // TLS 1.2

                                    // Ignorar la validación del certificado (solo para desarrollo)
                                    ServicePointManager.ServerCertificateValidationCallback += (sender, certificate, chain, sslPolicyErrors) => true;

                                    respListaNegras = wsListasNegras.SendTransaction(tramaEnviar);
                                }
                                catch (Exception ws)
                                {
                                    Logger.Error($"Error consumiendoRecibeInt:\n{ws.Message}\n{ws.StackTrace}");

                                    dtErrores.Rows.Add(1);
                                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E019";
                                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = $"Error consumiendo RecibeInt:\n{ws.Message}\n{ws.StackTrace}";
                                }
                            }
                            else
                            {
                                //Ejemplo de trama de respuesta.
                                respListaNegras =
                                "01019995014313".PadLeft(18, ' ') //identidad
                                + "IGLESIA DE LOS HERMANOS".PadLeft(200, ' ') //Nombre
                                + "F" //Respuesta
                                + "IGLESIA DE LOS HERMANOS".PadLeft(200, ' ') //NombreCoincidencia
                                + "89.54".PadRight(10, ' ') //Porcentaje
                                + "OFAC".PadLeft(50, ' '); //Lista
                            }

                            //Guarda LogSQL 
                            SQLSrv qLog = new SQLSrv(Properties.Settings.Default.cnx_wsListasNegras, "usp_LogEnvioRespuesta");
                            qLog.Parametros.Add(new SqlParameter("@UserName", usuario));
                            qLog.Parametros.Add(new SqlParameter("@TramaEnviada", tramaEnviar));
                            qLog.Parametros.Add(new SqlParameter("@Respuesta", respListaNegras));

                            Logger.Error($"Ejecutando usp_LogEnvioRespuesta: \nUserName: {usuario}\nTramaEnviada: '{tramaEnviar}'\nTramaRespuesta: '{respListaNegras}'");

                            DataTable dtLog = qLog.getDataTableWithParameters();


                            if (!qLog.Success)
                                Logger.Error($"No se pudo guardar LogSQL:\n{qLog.Mensaje}");
                            else
                            {
                                if (dtLog.Rows.Count > 0)
                                    respListaNegras = dtLog.Rows[0][0].ToString();
                            }
                        }                    

                        /* 

                        El cliente web que consume el web services puede esperar las siguientes respuestas por parte del servicio RecibeInt:
                        1.Encolamiento exitoso: Enqueue.
                        2.Encolamiento no exitoso: Failed to Enqueue.Esto puede deberse por errores de autorización a las colas MS - Queuing.
                        3.En caso la trama no sea correcta: Transaction error, check the date fields in the header, user in the header or length transaction.
                        4.En caso no se encontrará el evento parametrizado dentro de Monitor Plus®: Event not Found.
                        5.En caso el evento no se encuentre en el mensaje posteado: Event not Found in trx.

                        */

                        if (respListaNegras == null)
                        {
                            dtErrores.Rows.Add(1);
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E020";
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = $"No se obtuvo respuesta de RecibeInt de MonitorPlus.";
                        }
                        else if (respListaNegras.Contains("Enqueue"))
                        {
                            dtErrores.Rows.Add(1);
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E001";
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Encolamiento exitoso.";
                        }
                        else if (respListaNegras.Contains("Failed to Enqueue"))
                        {
                            dtErrores.Rows.Add(1);
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E002";
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Encolamiento no exitoso. Esto puede deberse por errores de autorización a las colas MS - Queuing.";
                        }
                        else if (respListaNegras.Contains("Transaction error"))
                        {
                            dtErrores.Rows.Add(1);
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E003";
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Error de transacción, verifique los campos de fecha en el encabezado, usuario en el encabezado o longitud de la transacción.";
                        }
                        else if (respListaNegras.Contains("Event not Found"))
                        {
                            dtErrores.Rows.Add(1);
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E004";
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "No se encontrará el evento parametrizado dentro de Monitor Plus®";
                        }
                        else if (respListaNegras.Contains("Event not Found in trx"))
                        {
                            dtErrores.Rows.Add(1);
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E005";
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "El evento no se encuentre en el mensaje posteado";
                        }
                        else if (respListaNegras.Length != 479)
                        {
                            dtErrores.Rows.Add(1);
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E018";
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = $"Ancho ({respListaNegras.Length.ToString()}) de Trama de Respuesta no esperado.\nRespuesta Recibida: {respListaNegras}";
                        }
                        else
                        {
                            //Identidad     Longitud    18      1,18
                            string respIdentidad = respListaNegras.Substring(0, 18).Trim();
                            //Nombre        Longitud    100     19,100
                            string respNombre = respListaNegras.Substring(18, 200).Trim();
                            //Respuesta     Longitud    1       120,1
                            string respRespuesta = respListaNegras.Substring(218, 1).Trim();
                            //NombreCoincidencia    Longitud    150     123,150
                            string respNombreCoincidencia = respListaNegras.Substring(219, 200).Trim();
                            //Porcentaje    Longitud    10      273,10
                            string respPorcentaje = respListaNegras.Substring(419, 10).Trim();
                            //Lista         Longitud    50      283,50
                            string respLista = respListaNegras.Substring(429, 50).Trim()    ;


                            //Agrega a dtListaNegra la respuesta recibida
                            dtListaNegra.Rows.Add(1);
                            dtListaNegra.Rows[dtListaNegra.Rows.Count - 1]["Respuesta"] = respRespuesta;
                        }
                    }
                    catch (Exception ex1)
                    {
                        Logger.Error($"EnvioTransaccion - Error General:\n{ex1.Message}");

                        dtErrores.Rows.Add(1);
                        dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E017";
                        dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = $"Error General - {ex1.Message}";
                    }
                }
            }

            //Agrega tablas al dataset de respuesta
            dsRespuesta.Tables.Add(dtErrores);
            dsRespuesta.Tables.Add(dtListaNegra);

            return dsRespuesta;
        }

        private bool ValidaFecha(string fecha)
        {
            bool fechaValida = true;
            DateTime fechaConvetida;
            CultureInfo provider = CultureInfo.InstalledUICulture;

            try
            {
                fechaConvetida = DateTime.ParseExact(fecha, "yyyyMMdd", provider);
            }
            catch
            {
                fechaValida = false;
            }

            return fechaValida;
        }

        private bool ValidaGrupo(string Grupo)
        {
            bool valido = false;

            SQLSrv qValidaGrupo = new SQLSrv(Properties.Settings.Default.cnx_wsListasNegras, "usp_ValidarGrupo");
            qValidaGrupo.Parametros.Add(new SqlParameter("@Grupo", Grupo));

            DataTable dtValidaGrupo = qValidaGrupo.getDataTableWithParameters();

            if (qValidaGrupo.Success)
            {
                if (dtValidaGrupo.Rows[0][0].ToString() == "1")
                    valido = true;
            }
            else
            {
                Logger.Error($"sendTransactionOC - Error ValidandoGrupo: \n {qValidaGrupo.Mensaje}");
            }

            return valido;
        }

        private bool CredencialesValidas(string usuario, string pass)
        {
            bool valido = false;

            if (!Properties.Settings.Default.ValidaUSREnvioTrama)
            {
                valido = true;
            }
            else
            {
                string passDescriptadoH = Seguridad.DesEncriptar(pass);
                string passDescriptado = string.Empty;

                SQLSrv qUsuarios = new SQLSrv(Properties.Settings.Default.cnx_wsListasNegras, "usp_MantUsuarios");
                qUsuarios.Parametros.Add(new SqlParameter("@opcion", 2));
                qUsuarios.Parametros.Add(new SqlParameter("@UserName", usuario));

                DataTable dtUsuario = qUsuarios.getDataTableWithParameters();

                if (qUsuarios.Success)
                {
                    if (dtUsuario.Rows.Count > 0)
                    {
                        passDescriptado = Seguridad.DesEncriptar(dtUsuario.Rows[0][0].ToString());
                    }

                    if (passDescriptado == passDescriptadoH)
                        valido = true;
                }
                else
                {
                    Logger.Error($"Error validando usuario: {usuario}\nError: {qUsuarios.Mensaje}");
                }
            }

            return valido;
        }
    }
}
