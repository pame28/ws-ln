using DataLayer;
using log4net;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Globalization;
using System.Linq;
using System.Net;
using System.Web;
using System.Web.Services;
using wsListasNegras.Clases;
using wsListasNegras.wsRecibeInt;

namespace wsListasNegras
{
    [WebService(Description = "WebService que funciona como puente para consultas a Listas Negras de MonitorPlus", Namespace = "http://wslistasnegras.banpais.hn/")]
    [WebServiceBinding(ConformsTo = WsiProfiles.BasicProfile1_1)]
    [System.ComponentModel.ToolboxItem(false)]
    public class ListasNegras : System.Web.Services.WebService
    {
        private static readonly ILog Logger = LogManager.GetLogger(typeof(xmlwsAD));
        RecibeIntSoapClient wsListasNegras = new RecibeIntSoapClient();

        [WebMethod]
        public DataSet sendTransactionDS(string tramaIdentidad, string tramaPrimerNombre, string tramaSegundoNombre,
            string tramaPrimerApellido, string tramaSegundoApellido, string tramaTipoPersona, string tramaNacionalidad,
            string tramaRazonSocial, string tramaFechaNacimiento, string tramaGrupoLista)
        {
            DataSet daEnvioTransaccion = EnvioTransaccion(tramaIdentidad, tramaPrimerNombre, tramaSegundoNombre,
                tramaPrimerApellido, tramaSegundoApellido, tramaTipoPersona, tramaNacionalidad, tramaRazonSocial,
                tramaFechaNacimiento, tramaGrupoLista);

            Logger.Info($"sendTransactionDS - Se retorno:\n{daEnvioTransaccion.GetXml()}");

            return daEnvioTransaccion;
        }

        [WebMethod]
        public clientBlackList sendTransactionOC(string tramaIdentidad, string tramaPrimerNombre, string tramaSegundoNombre,
            string tramaPrimerApellido, string tramaSegundoApellido, string tramaTipoPersona, string tramaNacionalidad,
            string tramaRazonSocial, string tramaFechaNacimiento, string tramaGrupoLista)
        {
            DataSet daEnvioTransaccion = new DataSet();

            try
            {
                daEnvioTransaccion = EnvioTransaccion(tramaIdentidad, tramaPrimerNombre, tramaSegundoNombre,
                    tramaPrimerApellido, tramaSegundoApellido, tramaTipoPersona, tramaNacionalidad, tramaRazonSocial,
                    tramaFechaNacimiento, tramaGrupoLista);
            }
            catch (Exception ex)
            {
                Logger.Error($"Error sendTransactionOC.\n{ex.Message}\n{ex.Source}\n{ex.StackTrace}");
            }

            clientBlackList rBlackList = new clientBlackList();

            if (daEnvioTransaccion.Tables["dtErrores"].Rows.Count > 0)
            {
                rBlackList.errores.codigo = daEnvioTransaccion.Tables["dtErrores"].Rows[0]["Codigo"].ToString();
                rBlackList.errores.descripcion = daEnvioTransaccion.Tables["dtErrores"].Rows[0]["Descripcion"].ToString();
            }
            if (daEnvioTransaccion.Tables["dtListaNegra"].Rows.Count > 0)
            {
                rBlackList.Respuesta = daEnvioTransaccion.Tables["dtListaNegra"].Rows[0]["Respuesta"].ToString();
            }

            Logger.Info($"sendTransactionOC - Se retorno:\n{rBlackList.toString()}");

            return rBlackList;
        }

        private DataSet EnvioTransaccion(string tramaIdentidad, string tramaPrimerNombre, string tramaSegundoNombre,
            string tramaPrimerApellido, string tramaSegundoApellido, string tramaTipoPersona, string tramaNacionalidad,
            string tramaRazonSocial, string tramaFechaNacimiento, string tramaGrupoLista)
        {
            DataSet daEnvioTransaccion = new DataSet("dsRespuesta");

            DataTable dtErrores = new DataTable("dtErrores");
            dtErrores.Columns.Add(new DataColumn("Codigo", typeof(string)));
            dtErrores.Columns.Add(new DataColumn("Descripcion", typeof(string)));

            DataTable dtListaNegra = new DataTable("dtListaNegra");
            dtListaNegra.Columns.Add(new DataColumn("Identidad", typeof(string)));
            dtListaNegra.Columns.Add(new DataColumn("Nombre", typeof(string)));
            dtListaNegra.Columns.Add(new DataColumn("Respuesta", typeof(string)));
            dtListaNegra.Columns.Add(new DataColumn("NombreCoincidencia", typeof(string)));
            dtListaNegra.Columns.Add(new DataColumn("Porcentaje", typeof(string)));
            dtListaNegra.Columns.Add(new DataColumn("Lista", typeof(string)));

            string RealTime = string.Empty;
            string Evento = string.Empty;
            string Usuario = string.Empty;

            SQLSrv qConfiguracionesBD = new SQLSrv(Properties.Settings.Default.cnx_wsListasNegras, "usp_GetConfiguraciones");
            qConfiguracionesBD.Parametros.Add(new SqlParameter("@IdBuscar", 3));

            Logger.Error($"Ejecutando usp_GetConfiguraciones @IdBuscar: 3");

            DataTable dtLogConfDT = qConfiguracionesBD.getDataTableWithParameters();

            if (!qConfiguracionesBD.Success)
                Logger.Error($"No se pudo guardar LogSQL:\n{qConfiguracionesBD.Mensaje}");
            else
            {
                if (dtLogConfDT.Rows.Count > 0)
                    RealTime = dtLogConfDT.Rows[0][0].ToString();
            }

            qConfiguracionesBD.Parametros.Add(new SqlParameter("@IdBuscar", 4));

            Logger.Error($"Ejecutando usp_GetConfiguraciones @IdBuscar: 4");

            dtLogConfDT = qConfiguracionesBD.getDataTableWithParameters();
            if (!qConfiguracionesBD.Success)
                Logger.Error($"No se pudo guardar LogSQL:\n{qConfiguracionesBD.Mensaje}");
            else
            {
                if (dtLogConfDT.Rows.Count > 0)
                    Evento = dtLogConfDT.Rows[0][0].ToString();
            }

            string usuario = string.Empty;
            string pass = string.Empty;
            bool superoValidaciones = true;

            if (Properties.Settings.Default.ValidaUSREnvioTrama)
            {
                try
                {
                    HttpContext context = HttpContext.Current;
                    usuario = context.Request.Headers["username"].ToString();
                    Usuario = usuario;
                    pass = context.Request.Headers["pass"].ToString();
                }
                catch (Exception ex)
                {
                    superoValidaciones = false;

                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E016";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = $"No se encontraron credenciales en el Header.\n{ex.Message}\n{ex.StackTrace}";
                }
            }

            if (!CredencialesValidas(usuario, pass))
            {
                dtErrores.Rows.Add(1);
                dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E000";
                dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Credenciales de no validas!";
                superoValidaciones = false;
            }

            // --- Aquí solo agregamos lógica de persona jurídica ---
            if (superoValidaciones)
            {
                DateTime FechaActual = DateTime.Now;
                string tramaFechaEvaluacion = FechaActual.ToString("yyyyMMdd");

                string primerNombre = tramaPrimerNombre;
                string segundoNombre = tramaSegundoNombre;
                string primerApellido = tramaPrimerApellido;
                string segundoApellido = tramaSegundoApellido;

                if (tramaTipoPersona.ToUpper() == "J")
                {
                    primerNombre = tramaRazonSocial;
                    segundoNombre = string.Empty;
                    primerApellido = string.Empty;
                    segundoApellido = string.Empty;
                }

                string tramaEnviar =
                    RealTime.ToUpper()
                    + FechaActual.Day.ToString().PadLeft(2, '0')
                    + FechaActual.Month.ToString().PadLeft(2, '0')
                    + FechaActual.Year.ToString().PadLeft(4, '0')
                    + FechaActual.Hour.ToString().PadLeft(2, '0')
                    + FechaActual.Minute.ToString().PadLeft(2, '0')
                    + Evento.PadLeft(5, '0')
                    + Usuario.PadRight(10, ' ')
                    + tramaIdentidad.PadRight(18, ' ')
                    + primerNombre.PadRight(50, ' ')
                    + segundoNombre.PadRight(50, ' ')
                    + primerApellido.PadRight(50, ' ')
                    + segundoApellido.PadRight(50, ' ')
                    + tramaTipoPersona.ToUpper()
                    + tramaFechaEvaluacion
                    + tramaNacionalidad.PadRight(20, ' ')
                    + tramaRazonSocial.PadRight(200, ' ').ToUpper()
                    + tramaFechaNacimiento
                    + tramaGrupoLista.PadLeft(2, '0')
                    + "".PadRight(47, ' ');

                tramaEnviar = tramaEnviar.ToUpper();
                Logger.Info($"EnvioTransaccion - Trama enviada a RecibeInt: '{tramaEnviar}'");

                // --- Resto del envío y logging original ---
                string respListaNegras = string.Empty;

                try
                {
                    SQLSrv qLogBD = new SQLSrv(Properties.Settings.Default.cnx_wsListasNegras, "usp_RevisarLogEnvioRepuesta");
                    qLogBD.Parametros.Add(new SqlParameter("@TramaEnviada", tramaEnviar));
                    DataTable dtogDT = qLogBD.getDataTableWithParameters();

                    if (dtogDT.Rows.Count > 0)
                        respListaNegras = dtogDT.Rows[0][0].ToString();
                    else
                    {
                        ServicePointManager.SecurityProtocol =
                            SecurityProtocolType.Tls |
                            SecurityProtocolType.Tls11 |
                            SecurityProtocolType.Tls12;
                        ServicePointManager.ServerCertificateValidationCallback += (sender, certificate, chain, sslPolicyErrors) => true;

                        respListaNegras = wsListasNegras.SendTransaction(tramaEnviar);
                    }
                }
                catch (Exception ws)
                {
                    Logger.Error($"Error consumiendo RecibeInt:\n{ws.Message}\n{ws.StackTrace}");
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E019";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = $"Error consumiendo RecibeInt:\n{ws.Message}\n{ws.StackTrace}";
                }

                // --- Procesamiento de la respuesta ---
                dtListaNegra.Rows.Add(1);
                dtListaNegra.Rows[dtListaNegra.Rows.Count - 1]["Respuesta"] = respListaNegras;
            }

            daEnvioTransaccion.Tables.Add(dtErrores);
            daEnvioTransaccion.Tables.Add(dtListaNegra);

            return daEnvioTransaccion;
        }

        private bool CredencialesValidas(string usuario, string pass)
        {
            bool valido = false;

            if (!Properties.Settings.Default.ValidaUSREnvioTrama)
            {
                valido = true;
            }
            else
            {
                string passDescriptadoH = Seguridad.DesEncriptar(pass);
                string passDescriptado = string.Empty;

                SQLSrv qUsuarios = new SQLSrv(Properties.Settings.Default.cnx_wsListasNegras, "usp_MantUsuarios");
                qUsuarios.Parametros.Add(new SqlParameter("@opcion", 2));
                qUsuarios.Parametros.Add(new SqlParameter("@UserName", usuario));

                DataTable dtUsuario = qUsuarios.getDataTableWithParameters();

                if (qUsuarios.Success)
                {
                    if (dtUsuario.Rows.Count > 0)
                    {
                        passDescriptado = Seguridad.DesEncriptar(dtUsuario.Rows[0][0].ToString());
                    }

                    if (passDescriptado == passDescriptadoH)
                        valido = true;
                }
                else
                {
                    Logger.Error($"Error validando usuario: {usuario}\nError: {qUsuarios.Mensaje}");
                }
            }

            return valido;
        }
    }
}
