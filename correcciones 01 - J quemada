Me gustaria corregir algo y es la J quemada ... no es correcto, pienso paramentrizarlo en la misma BD y tabla donde se almacena Evento y Realtime, que, en este mismo codigo se implementa.
Ayudame a hacer las correcciones para que la J de cliente juridico no est칠 quemado. ("@IdBuscar", 5) ESE ES PARA CLIENTE JURIDICO




using DataLayer;
using log4net;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Globalization;
using System.Linq;
using System.Net;
using System.Web;
using System.Web.Services;
using wsListasNegras.Clases;
using wsListasNegras.wsRecibeInt;




namespace wsListasNegras
{
    /// <summary>
    /// Summary description for ListasNegras
    /// </summary>
    [WebService(Description = "WebService que funciona como puente para consultas a Listas Negras de MonitorPlus", Namespace = "http://wslistasnegras.banpais.hn/")]
    [WebServiceBinding(ConformsTo = WsiProfiles.BasicProfile1_1)]
    [System.ComponentModel.ToolboxItem(false)]
    // To allow this Web Service to be called from script, using ASP.NET AJAX, uncomment the following line. 
    // [System.Web.Script.Services.ScriptService]
    public class ListasNegras : System.Web.Services.WebService
    {
        private static readonly ILog Logger = LogManager.GetLogger(typeof(xmlwsAD));
        RecibeIntSoapClient wsListasNegras = new RecibeIntSoapClient();

        [WebMethod]
        public DataSet sendTransactionDS(string tramaIdentidad, string tramaPrimerNombre, string tramaSegundoNombre, string tramaPrimerApellido, string tramaSegundoApellido, string tramaTipoPersona, string tramaNacionalidad, string tramaRazonSocial, string tramaFechaNacimiento, string tramaGrupoLista)
        {
            DataSet dsEnvioTransaccion = EnvioTransaccion(tramaIdentidad, tramaPrimerNombre, tramaSegundoNombre, tramaPrimerApellido, tramaSegundoApellido, tramaTipoPersona, tramaNacionalidad, tramaRazonSocial, tramaFechaNacimiento, tramaGrupoLista);

            Logger.Info($"sendTransactionDS - Se retorno:\n{dsEnvioTransaccion.GetXml()}");

            return dsEnvioTransaccion;
        }

        [WebMethod]
        public clientBlackList sendTransactionOC(string tramaIdentidad, string tramaPrimerNombre, string tramaSegundoNombre, string tramaPrimerApellido, string tramaSegundoApellido, string tramaTipoPersona, string tramaNacionalidad, string tramaRazonSocial, string tramaFechaNacimiento, string tramaGrupoLista)
        {
            
            DataSet dsEnvioTransaccion = new DataSet();

            try
            {
                dsEnvioTransaccion = EnvioTransaccion(tramaIdentidad, tramaPrimerNombre, tramaSegundoNombre, tramaPrimerApellido, tramaSegundoApellido, tramaTipoPersona, tramaNacionalidad, tramaRazonSocial, tramaFechaNacimiento, tramaGrupoLista);
            }
            catch(Exception ex)
            {
                Logger.Error($"Error sendTransactionOC.\n{ex.Message}\n{ex.Source}\n{ex.StackTrace}");
            }

            //Pasamos de DataSet a Objeto Complejo para el return
            clientBlackList rBlackList = new clientBlackList();

            if (dsEnvioTransaccion.Tables["dtErrores"].Rows.Count > 0)
            {
                rBlackList.errores.codigo = dsEnvioTransaccion.Tables["dtErrores"].Rows[0]["Codigo"].ToString();
                rBlackList.errores.descripcion = dsEnvioTransaccion.Tables["dtErrores"].Rows[0]["Descripcion"].ToString();
            }
            if (dsEnvioTransaccion.Tables["dtListaNegra"].Rows.Count > 0)
            {
                rBlackList.Respuesta = dsEnvioTransaccion.Tables["dtListaNegra"].Rows[0]["Respuesta"].ToString();
            }

            Logger.Info($"sendTransactionOC - Se retorno:\n{rBlackList.toString()}");

            return rBlackList;
        }

        private DataSet EnvioTransaccion(string tramaIdentidad, string tramaPrimerNombre, string tramaSegundoNombre, string tramaPrimerApellido, string tramaSegundoApellido, string tramaTipoPersona, string tramaNacionalidad, string tramaRazonSocial, string tramaFechaNacimiento, string tramaGrupoLista)
        {
            DataSet dsRespuesta = new DataSet("dsRespuesta");

            DataTable dtErrores = new DataTable("dtErrores");
            dtErrores.Columns.Add(new DataColumn("Codigo", typeof(string)));
            dtErrores.Columns.Add(new DataColumn("Descripcion", typeof(string)));

            DataTable dtListaNegra = new DataTable("dtListaNegra");
            dtListaNegra.Columns.Add(new DataColumn("Identidad", typeof(string)));
            dtListaNegra.Columns.Add(new DataColumn("Nombre", typeof(string)));
            dtListaNegra.Columns.Add(new DataColumn("Respuesta", typeof(string)));
            dtListaNegra.Columns.Add(new DataColumn("NombreCoincidencia", typeof(string)));
            dtListaNegra.Columns.Add(new DataColumn("Porcentaje", typeof(string)));
            dtListaNegra.Columns.Add(new DataColumn("Lista", typeof(string)));

            string RealTime = string.Empty;
            string Evento = string.Empty;
            string Usuario = string.Empty;

            SQLSrv qConfiguracionesBD = new SQLSrv(Properties.Settings.Default.cnx_wsListasNegras, "usp_GetConfiguraciones");
            qConfiguracionesBD.Parametros.Add(new SqlParameter("@IdBuscar", 3));

            Logger.Error($"Ejecutando usp_GetConfiguraciones @IdBuscar: 3");

            DataTable dtLogConfDT = qConfiguracionesBD.getDataTableWithParameters();

            if (!qConfiguracionesBD.Success)
                Logger.Error($"No se pudo guardar LogSQL:\n{qConfiguracionesBD.Mensaje}");
            else
            {
                if (dtLogConfDT.Rows.Count > 0)
                    RealTime = dtLogConfDT.Rows[0][0].ToString();
            }

            qConfiguracionesBD.Parametros.Add(new SqlParameter("@IdBuscar", 4));

            Logger.Error($"Ejecutando usp_GetConfiguraciones @IdBuscar: 4");

            dtLogConfDT = qConfiguracionesBD.getDataTableWithParameters();
            if (!qConfiguracionesBD.Success)
                Logger.Error($"No se pudo guardar LogSQL:\n{qConfiguracionesBD.Mensaje}");
            else
            {
                if (dtLogConfDT.Rows.Count > 0)
                    Evento = dtLogConfDT.Rows[0][0].ToString();
            }

            string usuario = string.Empty;
            string pass = string.Empty;
            bool superoValidaciones = true;

            if (Properties.Settings.Default.ValidaUSREnvioTrama)
            {
                try
                {
                    HttpContext context = HttpContext.Current;
                    usuario = context.Request.Headers["username"].ToString();
                    Usuario = usuario;
                    pass = context.Request.Headers["pass"].ToString();
                }
                catch (Exception ex)
                {
                    superoValidaciones = false;

                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E016";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = $"No se encontraron credenciales en el Header.\n{ex.Message}\n{ex.StackTrace}";
                }
            }

            //Validando usuario y contrase침a del Header
            if (!CredencialesValidas(usuario, pass))
            {
                dtErrores.Rows.Add(1);
                dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E000";
                dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Credenciales de no validas!";
            }
            else
            {

                //Validaciones
                if (RealTime.ToUpper() != "S" && RealTime.ToUpper() != "N")
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E006";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro RealTime solo puede ser S o N.";
                    superoValidaciones = false;
                }

                if (Evento.ToString().Length > 5)
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E007";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro Evento solo puede ser de 5 digitos.";
                    superoValidaciones = false;
                }


                // Normalizar nulls (evitar NRE)
                tramaIdentidad = tramaIdentidad ?? string.Empty;
                tramaPrimerNombre = tramaPrimerNombre ?? string.Empty;
                tramaSegundoNombre = tramaSegundoNombre ?? string.Empty;
                tramaPrimerApellido = tramaPrimerApellido ?? string.Empty;
                tramaSegundoApellido = tramaSegundoApellido ?? string.Empty;
                tramaTipoPersona = (tramaTipoPersona ?? string.Empty).Trim().ToUpper();
                tramaNacionalidad = tramaNacionalidad ?? string.Empty;
                tramaRazonSocial = tramaRazonSocial ?? string.Empty;
                tramaFechaNacimiento = tramaFechaNacimiento ?? string.Empty;
                tramaGrupoLista = tramaGrupoLista ?? string.Empty;

                // Validaciones globales (siempre obligatorias)
           
                if (string.IsNullOrWhiteSpace(tramaTipoPersona))
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E001";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "El campo 'Tipo Persona' no puede estar vac칤o.";
                    superoValidaciones = false;
                }


                if (string.IsNullOrWhiteSpace(tramaGrupoLista))
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E004";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "El campo 'Grupo Lista' no puede estar vac칤o.";
                    superoValidaciones = false;
                }


                 if (tramaTipoPersona == "J") // Persona Jur칤dica: campos de nombre/apellido deben estar VAC칈OS; razonSocial obligatorio
                {
                    if (!string.IsNullOrWhiteSpace(tramaPrimerNombre))
                    {
                        dtErrores.Rows.Add(1);
                        dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E021";
                        dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "El campo 'Primer Nombre' debe estar vac칤o para personas jur칤dicas.";
                        superoValidaciones = false;
                    }

                    if (!string.IsNullOrWhiteSpace(tramaSegundoNombre))
                    {
                        dtErrores.Rows.Add(1);
                        dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E022";
                        dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "El campo 'Segundo Nombre' debe estar vac칤o para personas jur칤dicas.";
                        superoValidaciones = false;
                    }

                    if (!string.IsNullOrWhiteSpace(tramaPrimerApellido))
                    {
                        dtErrores.Rows.Add(1);
                        dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E023";
                        dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "El campo 'Primer Apellido' debe estar vac칤o para personas jur칤dicas.";
                        superoValidaciones = false;
                    }

                    if (!string.IsNullOrWhiteSpace(tramaSegundoApellido))
                    {
                        dtErrores.Rows.Add(1);
                        dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E024";
                        dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "El campo 'Segundo Apellido' debe estar vac칤o para personas jur칤dicas.";
                        superoValidaciones = false;
                    }

                    if (string.IsNullOrWhiteSpace(tramaRazonSocial))
                    {
                        dtErrores.Rows.Add(1);
                        dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E025";
                        dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "El campo 'Raz칩n Social' es obligatorio para personas jur칤dicas.";
                        superoValidaciones = false;
                    }
                }


                if (tramaIdentidad.Length > 18)
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E008";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro tramaIdentidad no puede ser mas de 18 caracteres.";
                    superoValidaciones = false;
                }

                if (tramaTipoPersona.ToUpper() != "N" && tramaTipoPersona.ToUpper() != "J")
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E009";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro tramaTipoPersona solo puede ser N o J.";
                    superoValidaciones = false;
                }

                if (tramaNacionalidad.Length > 20)
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E010";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro tramaNacionalidad solo puede ser de 20 caracteres.";
                    superoValidaciones = false;
                }

                if (tramaRazonSocial.Length > 200)
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E011";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro tramaRazonSocial solo puede ser de 200 caracteres.";
                    superoValidaciones = false;
                }

                if (tramaFechaNacimiento.Length != 8)
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E012";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro tramaFechaNacimiento solo puede ser de 8 caracteres.";
                    superoValidaciones = false;
                }

                if (!ValidaFecha(tramaFechaNacimiento))
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E013";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro tramaFechaNacimiento no tiene un formato valido.";
                    superoValidaciones = false;
                }

                if (tramaGrupoLista.Length > 2)
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E014";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro tramaGrupoLista solo puede ser de 2 caracteres.";
                    superoValidaciones = false;
                }

                if (!ValidaGrupo(tramaGrupoLista))
                {
                    dtErrores.Rows.Add(1);
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E015";
                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Parametro tramaGrupo no tiene un valor valido.";
                    superoValidaciones = false;
                }

                if (superoValidaciones)
                {
                    DateTime FechaActual = System.DateTime.Now;
                    string tramaFechaEvaluacion = FechaActual.ToString("yyyyMMdd");



                    // 游댳 INICIO CAMBIO: Si persona juridica y flag activo, copiar razon social a primer nombre (solo para la trama enviada)
         

                        if (Properties.Settings.Default.CopiarRazonSocialAPrimerNombre == true && tramaTipoPersona.ToUpper() == "J")
                    {
                        // Solo copiamos si primer nombre est치 vac칤o (para no sobreescribir info que el consumidor haya colocado)
                        if (string.IsNullOrWhiteSpace(tramaPrimerNombre) && !string.IsNullOrWhiteSpace(tramaRazonSocial))
                        {
                            tramaPrimerNombre = tramaRazonSocial;
                          ;
                        }
                    }


                    //Arma trama a Enviar en metodo SendTransaction
                    string tramaEnviar =
                        RealTime.ToUpper()
                        + FechaActual.Day.ToString().PadLeft(2, '0')
                        + FechaActual.Month.ToString().PadLeft(2, '0')
                        + FechaActual.Year.ToString().PadLeft(4, '0')
                        + FechaActual.Hour.ToString().PadLeft(2, '0')
                        + FechaActual.Minute.ToString().PadLeft(2, '0')
                        + Evento.ToString().PadLeft(5, '0')
                        + Usuario.PadRight(10, ' ').ToUpper()
                        + tramaIdentidad.PadRight(18, ' ')
                        + tramaPrimerNombre.PadRight(50, ' ')
                        + tramaSegundoNombre.PadRight(50, ' ')
                        + tramaPrimerApellido.PadRight(50, ' ')
                        + tramaSegundoApellido.PadRight(50, ' ')
                        + tramaTipoPersona.ToUpper()
                        + tramaFechaEvaluacion
                        + tramaNacionalidad.PadRight(20, ' ')
                        + tramaRazonSocial.PadRight(200, ' ').ToUpper()
                        + tramaFechaNacimiento
                        + tramaGrupoLista.PadLeft(2, '0')
                        + "".PadRight(47, ' ');

                    tramaEnviar = tramaEnviar.ToUpper();

                    Logger.Info($"EnvioTransaccion - Trama enviada a RecibeInt: '{tramaEnviar}'");

                    //Consumir web service
                    string respListaNegras = string.Empty;

                    try
                    {
                        //Se revisa si ya se consulto anteriormente este trama y si esta en la bd

                        SQLSrv qLogBD = new SQLSrv(Properties.Settings.Default.cnx_wsListasNegras, "usp_RevisarLogEnvioRepuesta");
                        qLogBD.Parametros.Add(new SqlParameter("@TramaEnviada", tramaEnviar));

                        Logger.Error($"Ejecutando usp_RevisarLogEnvioRepuesta @TramaEnviada: {tramaEnviar}");

                        DataTable dtogDT = qLogBD.getDataTableWithParameters();

                        if(!qLogBD.Success)
                        {
                            Logger.Error($"Error Ejecutando usp_RevisarLogEnvioRepuesta @TramaEnviada: {tramaEnviar}");
                        }
                        else
                        {
                            if(dtogDT.Rows.Count>0)
                                respListaNegras = dtogDT.Rows[0][0].ToString();
                        }                     


                        if (dtogDT.Rows.Count <= 0)
                        {
                            if (Properties.Settings.Default.UsarRespuestaAutomatica == false)
                            {
                                try
                                {
                                    ServicePointManager.SecurityProtocol =
                                    SecurityProtocolType.Tls |           // TLS 1.0
                                    SecurityProtocolType.Tls11 |         // TLS 1.1
                                    SecurityProtocolType.Tls12;         // TLS 1.2

                                    // Ignorar la validaci칩n del certificado (solo para desarrollo)
                                    ServicePointManager.ServerCertificateValidationCallback += (sender, certificate, chain, sslPolicyErrors) => true;

                                    respListaNegras = wsListasNegras.SendTransaction(tramaEnviar);
                                }
                                catch (Exception ws)
                                {
                                    Logger.Error($"Error consumiendoRecibeInt:\n{ws.Message}\n{ws.StackTrace}");

                                    dtErrores.Rows.Add(1);
                                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E019";
                                    dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = $"Error consumiendo RecibeInt:\n{ws.Message}\n{ws.StackTrace}";
                                }
                            }
                            else
                            {

                                //Ejemplo de trama de respuesta.
                                respListaNegras =
                                "01019995014313".PadLeft(18, ' ') //identidad
                                + "IGLESIA DE LOS HERMANOS".PadLeft(200, ' ') //Nombre
                                + "F" //Respuesta
                                + "IGLESIA DE LOS HERMANOS".PadLeft(200, ' ') //NombreCoincidencia
                                + "89.54".PadRight(10, ' ') //Porcentaje
                                + "OFAC".PadLeft(50, ' '); //Lista

                            }

                            //Guarda LogSQL 
                            SQLSrv qLog = new SQLSrv(Properties.Settings.Default.cnx_wsListasNegras, "usp_LogEnvioRespuesta");
                            qLog.Parametros.Add(new SqlParameter("@UserName", usuario));
                            qLog.Parametros.Add(new SqlParameter("@TramaEnviada", tramaEnviar));
                            qLog.Parametros.Add(new SqlParameter("@Respuesta", respListaNegras));

                            Logger.Error($"Ejecutando usp_LogEnvioRespuesta: \nUserName: {usuario}\nTramaEnviada: '{tramaEnviar}'\nTramaRespuesta: '{respListaNegras}'");

                            DataTable dtLog = qLog.getDataTableWithParameters();


                            if (!qLog.Success)
                                Logger.Error($"No se pudo guardar LogSQL:\n{qLog.Mensaje}");
                            else
                            {
                                if (dtLog.Rows.Count > 0)
                                    respListaNegras = dtLog.Rows[0][0].ToString();
                            }
                        }

                        /* 

                        El cliente web que consume el web services puede esperar las siguientes respuestas por parte del servicio RecibeInt:
                        1.Encolamiento exitoso: Enqueue.
                        2.Encolamiento no exitoso: Failed to Enqueue.Esto puede deberse por errores de autorizaci칩n a las colas MS - Queuing.
                        3.En caso la trama no sea correcta: Transaction error, check the date fields in the header, user in the header or length transaction.
                        4.En caso no se encontrar치 el evento parametrizado dentro de Monitor Plus춽: Event not Found.
                        5.En caso el evento no se encuentre en el mensaje posteado: Event not Found in trx.

                        */

                        if (string.IsNullOrEmpty(respListaNegras))
                        {
                            dtErrores.Rows.Add(1);
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E020";
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = $"No se obtuvo respuesta de RecibeInt de MonitorPlus.";
                        }
                        else if (respListaNegras.Contains("Enqueue"))
                        {
                            dtErrores.Rows.Add(1);
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E001";
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Encolamiento exitoso.";
                        }
                        else if (respListaNegras.Contains("Failed to Enqueue"))
                        {
                            dtErrores.Rows.Add(1);
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E002";
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Encolamiento no exitoso. Esto puede deberse por errores de autorizaci칩n a las colas MS - Queuing.";
                        }
                        else if (respListaNegras.Contains("Transaction error"))
                        {
                            dtErrores.Rows.Add(1);
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E003";
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "Error de transacci칩n, verifique los campos de fecha en el encabezado, usuario en el encabezado o longitud de la transacci칩n.";
                        }
                        else if (respListaNegras.Contains("Event not Found"))
                        {
                            dtErrores.Rows.Add(1);
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E004";
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "No se encontrar치 el evento parametrizado dentro de Monitor Plus춽";
                        }
                        else if (respListaNegras.Contains("Event not Found in trx"))
                        {
                            dtErrores.Rows.Add(1);
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E005";
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = "El evento no se encuentre en el mensaje posteado";
                        }
                        else if (respListaNegras.Length != 479)
                        {
                            dtErrores.Rows.Add(1);
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E018";
                            dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = $"Ancho ({respListaNegras.Length.ToString()}) de Trama de Respuesta no esperado.\nRespuesta Recibida: {respListaNegras}";
                        }
                        else
                        {
                            //Identidad     Longitud    18      1,18
                            string respIdentidad = respListaNegras.Substring(0, 18).Trim();
                            //Nombre        Longitud    100     19,100
                            string respNombre = respListaNegras.Substring(18, 200).Trim();
                            //Respuesta     Longitud    1       120,1
                            string respRespuesta = respListaNegras.Substring(218, 1).Trim();
                            //NombreCoincidencia    Longitud    150     123,150
                            string respNombreCoincidencia = respListaNegras.Substring(219, 200).Trim();
                            //Porcentaje    Longitud    10      273,10
                            string respPorcentaje = respListaNegras.Substring(419, 10).Trim();
                            //Lista         Longitud    50      283,50
                            string respLista = respListaNegras.Substring(429, 50).Trim()    ;


                            //Agrega a dtListaNegra la respuesta recibida
                            dtListaNegra.Rows.Add(1);
                            dtListaNegra.Rows[dtListaNegra.Rows.Count - 1]["Respuesta"] = respRespuesta;
                        }
                    }
                    catch (Exception ex1)
                    {
                        Logger.Error($"EnvioTransaccion - Error General:\n{ex1.Message}");

                        dtErrores.Rows.Add(1);
                        dtErrores.Rows[dtErrores.Rows.Count - 1]["Codigo"] = "E017";
                        dtErrores.Rows[dtErrores.Rows.Count - 1]["Descripcion"] = $"Error General - {ex1.Message}";
                    }
                }
            }

            //Agrega tablas al dataset de respuesta
            dsRespuesta.Tables.Add(dtErrores);
            dsRespuesta.Tables.Add(dtListaNegra);

            return dsRespuesta;
        }

        private bool ValidaFecha(string fecha)
        {
            bool fechaValida = true;
            DateTime fechaConvetida;
            CultureInfo provider = CultureInfo.InstalledUICulture;

            try
            {
                fechaConvetida = DateTime.ParseExact(fecha, "yyyyMMdd", provider);
            }
            catch
            {
                fechaValida = false;
            }

            return fechaValida;
        }

        private bool ValidaGrupo(string Grupo)
        {
            bool valido = false;

            SQLSrv qValidaGrupo = new SQLSrv(Properties.Settings.Default.cnx_wsListasNegras, "usp_ValidarGrupo");
            qValidaGrupo.Parametros.Add(new SqlParameter("@Grupo", Grupo));

            DataTable dtValidaGrupo = qValidaGrupo.getDataTableWithParameters();

            if (qValidaGrupo.Success)
            {
                if (dtValidaGrupo.Rows[0][0].ToString() == "1")
                    valido = true;
            }
            else
            {
                Logger.Error($"sendTransactionOC - Error ValidandoGrupo: \n {qValidaGrupo.Mensaje}");
            }

            return valido;
        }

        private bool CredencialesValidas(string usuario, string pass)
        {
            bool valido = false;

            if (!Properties.Settings.Default.ValidaUSREnvioTrama)
            {
                valido = true;
            }
            else
            {
                string passDescriptadoH = Seguridad.DesEncriptar(pass);
                string passDescriptado = string.Empty;

                SQLSrv qUsuarios = new SQLSrv(Properties.Settings.Default.cnx_wsListasNegras, "usp_MantUsuarios");
                qUsuarios.Parametros.Add(new SqlParameter("@opcion", 2));
                qUsuarios.Parametros.Add(new SqlParameter("@UserName", usuario));

                DataTable dtUsuario = qUsuarios.getDataTableWithParameters();

                if (qUsuarios.Success)
                {
                    if (dtUsuario.Rows.Count > 0)
                    {
                        passDescriptado = Seguridad.DesEncriptar(dtUsuario.Rows[0][0].ToString());
                    }

                    if (passDescriptado == passDescriptadoH)
                        valido = true;
                }
                else
                {
                    Logger.Error($"Error validando usuario: {usuario}\nError: {qUsuarios.Mensaje}");
                }
            }

            return valido;
        }
    }
}
